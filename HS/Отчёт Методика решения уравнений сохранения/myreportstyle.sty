% Стилевые настойки для написания отчёта (Чернецов Н. Г., январь 2015 г.)

% Общие пакеты для XeTeX и PdfTeX
\RequirePackage{indentfirst} % Отступ в первом абзаце
\RequirePackage[left=30mm,right=15mm,top=20mm,bottom=20mm,headsep=0pt]{geometry} % Поля
\RequirePackage[nodisplayskipstretch]{setspace} % Отступы, исправляет пробелы вокруг выключных формул
\RequirePackage{enumitem} % работа со списками
\RequirePackage[nottoc,section]{tocbibind} % в оглавление ссылку на список источников
\RequirePackage{ccaption}
\RequirePackage{etoolbox}
\RequirePackage{titlesec}
\RequirePackage{refcount}
\frenchspacing
%\linespread{1.3} % Полуторный интервал для текста всего документа
\onehalfspacing

% Настройки в зависимости от выбранного компилятора
\RequirePackage{ifxetex}
\ifxetex
% XeLaTeX
\RequirePackage{polyglossia}
\setmainlanguage[spelling=new,babelshorthands=true]{russian}
\RequirePackage{fontspec}
%\RequirePackage{mathspec}
\defaultfontfeatures{Ligatures={TeX}}
%\newfontfamily{\cyrillicfont}{Adobe Garamond Pro} 
\setmainfont{Times New Roman} % Основной шрифт документа
\setsansfont{Times New Roman} % Шрифт без засечек
\setmonofont{Consolas}        % Моноширинный шрифт
\RequirePackage{graphicx}
\RequirePackage{hyperref} 
\renewcommand{\dots}{\ldots} % \dots работает неадекватно
\RequirePackage{amsmath} 
\RequirePackage[math-style=TeX]{unicode-math}
\setmathfont{Asana Math} % Математический шрифт
%\setmathfont{texgyrepagella-math.otf} % файл в папке со шрифтами usr/share/texmf/fonts...

\else
% default: pdfLaTeX
% Подключаем пакеты
\RequirePackage[T2A]{fontenc}
%\RequirePackage{misccorr}
\RequirePackage[utf8]{inputenc} 
\RequirePackage[english,russian]{babel}
\RequirePackage{float}
\RequirePackage[pdftex]{graphicx}
\RequirePackage{titlepic} % Картинка на титульном листе
\RequirePackage{amsfonts,amssymb,amsmath}
\RequirePackage{textcomp}
\RequirePackage{fancyhdr} 
\RequirePackage[pdftex]{hyperref} % гиперссылки в PDF-документе
\RequirePackage{enumitem}
\RequirePackage{lastpage}
\RequirePackage{verbatim} 

\addto\captionsrussian{%Содержание
\def\contentsname{%
\CYRS\cyro\cyrd\cyre\cyrr\cyrzh\cyra\cyrn\cyri\cyre}%
}

\addto\captionsrussian{%Список использованных источников
\def\bibname{%
\CYRS\cyrp\cyri\cyrs\cyro\cyrk~
\cyri\cyrs\cyrp\cyro\cyrl\cyrsftsn\cyrz\cyro\cyrv\cyra\cyrn\cyrn\cyrery\cyrh~
\cyri\cyrs\cyrt\cyro\cyrch\cyrn\cyri\cyrk\cyro\cyrv}%
}

\fi

\graphicspath{{pictures/}} % Папка с рисунками

% Сброс счётчиков уравнений и рисунков с началом каждого раздела
\@addtoreset{equation}{section}
\@addtoreset{figure}{section}

\pagestyle{plain} 

\captiondelim{ --- } % заменяем для рисунков ’:’ после номера рисунка на длинное тире

\renewcommand{\bfdefault}{b} % Более красивое начертание полужирного шрифта
% Нумерация разделов, формул, рисунков и т.д.
\renewcommand{\thesection}{\arabic{section}}
\renewcommand{\theequation}{\arabic{section}.\arabic{equation}}
\renewcommand{\thefigure}{\arabic{section}.\arabic{figure}} 

\renewcommand{\@biblabel}[1]{#1.} % Заменяем библиографию с квадратных скобок на точку
\renewcommand{\theenumi}{\arabic{enumi}} % Меняем везде перечисления на цифра.цифра
\renewcommand{\labelenumi}{\arabic{enumi}.} % Меняем везде перечисления на цифра.цифра
\renewcommand{\theenumii}{.\arabic{enumii}} % Меняем везде перечисления на цифра.цифра
\renewcommand{\labelenumii}{\arabic{enumi}.\arabic{enumii}.} % Меняем везде перечисления на цифра.цифра
\renewcommand{\labelenumiii}{\arabic{enumi}.\arabic{enumii}.\arabic{enumiii}.} % Меняем везде перечисления на цифра.цифра

% Отступы до и после формул	
%\setlength{\abovedisplayskip}{15pt} 
%\setlength{\belowdisplayskip}{15pt} 
\parindent=1.25cm % абзацный отступ

\setcounter{secnumdepth}{3} % автонумерация вплоть до subsubsection
\setcounter{tocdepth}{3} % включать в оглавление вплоть до subsubsection

% Переопределяем оформление заголовков разделов
\renewcommand{\section}{\@startsection{section}{1}%
{\parindent}{3.5ex plus 1ex minus .2ex}%
{2.3ex plus.2ex}{\normalfont\Large}}
\renewcommand{\subsection}{\@startsection{subsection}{2}%
{\parindent}{-2.25ex plus -1ex minus -.2ex}%
{1.5ex plus.2ex}{\normalfont\large}}
\renewcommand{\subsubsection}{\@startsection{subsubsection}{3}%
{\parindent}{-1.5ex plus -1ex minus -.2ex}%
{1.5ex plus.2ex}{\normalfont\large}}

% Переопределяем оформление оглавления
\renewcommand{\l@section}{\@dottedtocline{1}{0.0em}{1.5em}}
\renewcommand{\l@subsection}{\@dottedtocline{2}{1.5em}{2.0em}}
\renewcommand{\l@subsubsection}{\@dottedtocline{3}{3.0em}{2.5em}}
\renewcommand{\@dotsep}{3.8} % густота точек

% Определяем переменную для размера вставляемой картинки
\newcommand{\maxwidth}{%
\ifdim \Gin@nat@width>\linewidth
  \linewidth
\else
  \Gin@nat@width
\fi
}

% Подавляем висячие строки
\clubpenalty = 10000
\widowpenalty = 10000

% Подсчитываем количество рисунков, таблиц, формул, источников
\newcounter{totfigures}
\newcounter{tottables}
\newcounter{totequations}
\newcounter{totreferences}

\AtEndDocument{%
\addtocounter{totfigures}{\value{figure}}%
\addtocounter{tottables}{\value{table}}%
\addtocounter{totequations}{\value{equation}}%
\immediate\write\@mainaux{%
\string\gdef\string\totfig{\number\value{totfigures}}%
\string\gdef\string\tottab{\number\value{tottables}}%
\string\gdef\string\totequa{\number\value{totequations}}%
\string\gdef\string\totref{\number\value{totreferences}}%    
}%
}

% Сбросить счётчики после библиографии, чтобы правильно считалось общее количество объектов
\newcommand{\resetCountersAfterBib}{
\setcounter{figure}{0}
\setcounter{equation}{0}
\setcounter{table}{0}
}

\pretocmd{\section}{\addtocounter{totfigures}{\value{figure}}}{}{}
\pretocmd{\section}{\addtocounter{tottables}{\value{table}}}{}{}
\pretocmd{\section}{\addtocounter{totequations}{\value{equation}}}{}{}
\pretocmd{\bibitem}{\addtocounter{totreferences}{1}}{}{}









